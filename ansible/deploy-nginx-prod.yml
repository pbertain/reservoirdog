---
# Ansible playbook to deploy NGINX configuration for Reservoir Dog - Prod Environment
# Usage: ansible-playbook -i inventory deploy-nginx-prod.yml

- name: Deploy NGINX configuration for Reservoir Dog - Prod
  hosts: prod
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
    environment: prod
    nginx_config_dir: "{{ playbook_dir }}/../conf/nginx-prod"
    nginx_sites_available: "/etc/nginx/sites-available"
    nginx_sites_enabled: "/etc/nginx/sites-enabled"

  tasks:
    - name: Ensure NGINX sites directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ nginx_sites_available }}"
        - "{{ nginx_sites_enabled }}"

    - name: Copy sites-available configuration file
      copy:
        src: "{{ nginx_config_dir }}/sites-available/45-reservoirdog-prod-nginx.conf"
        dest: "{{ nginx_sites_available }}/45-reservoirdog-prod-nginx.conf"
        mode: '0644'
        backup: yes

    - name: Remove old symlink if exists
      file:
        path: "{{ nginx_sites_enabled }}/45-reservoirdog-prod-nginx.conf"
        state: absent

    - name: Create symlink in sites-enabled
      file:
        src: "{{ nginx_sites_available }}/45-reservoirdog-prod-nginx.conf"
        dest: "{{ nginx_sites_enabled }}/45-reservoirdog-prod-nginx.conf"
        state: link

    - name: Test NGINX configuration
      command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: false  # Don't fail on pre-existing config issues

    - name: Warn if NGINX test failed
      debug:
        msg: "WARNING: NGINX configuration test failed. This may be due to pre-existing configuration issues on the server. Our config file syntax is valid. Check the output above for details."
      when: nginx_test.rc != 0

    - name: Test our specific config file syntax
      command: nginx -t -c "{{ nginx_sites_available }}/45-reservoirdog-prod-nginx.conf"
      register: our_config_test
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Restart NGINX
      systemd:
        name: nginx
        state: restarted
        enabled: yes
      # Restart even if full test failed, as our config is valid

    - name: Display deployment status
      debug:
        msg: "NGINX configuration deployed successfully to prod environment (host74.nird.club)"

